<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ì—Ä–∞—Ñ–∏–∫</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-gradient: linear-gradient(135deg,#1e1e1e,#2c2c2c);
  --card:#2a2a2a; --muted:#aaaaaa;
  --accent:#4caf50; --accent-hover:#45a049; --today:#ff9800;
  --thin-border:#444; --morning:#264f6b; --evening:#665500;
  --fullday:#b3571e; --training:#28a745; --empty:#2a2a2a;
  --font-sans:'Inter', sans-serif; --shadow:0 6px 18px rgba(0,0,0,0.5);
  --text-color:#ffffff;
}
body{margin:0;font-family:var(--font-sans);background:var(--bg-gradient);color:var(--text-color);}
.container{max-width:1100px;margin:28px auto;padding:18px;}
header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
h1{font-size:36px;font-weight:700;color:#fff;background:linear-gradient(135deg,#4caf50,#00bcd4);padding:10px 20px;border-radius:12px;display:inline-block;box-shadow:0 6px 18px rgba(0,0,0,0.5);}
.small{color:var(--muted);}
.controls{display:flex; gap:10px; align-items:end; flex-wrap:wrap; margin-top:12px;}
.control{display:flex;flex-direction:column;font-size:13px;color:var(--text-color);}
select,input[type="date"],button{padding:8px 12px;font-size:14px;border-radius:10px;border:1px solid #555;background:#3a3a3a;color:#fff;transition:all 0.3s;}
select:focus,input[type="date"]:focus{border-color:#3b82f6;outline:none;}
button{background:var(--accent);color:#fff;border:none;cursor:pointer;transition:all 0.3s;}
button:hover{background:var(--accent-hover);}
.table-wrap{margin-top:18px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow);overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:max-content;min-width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed;}
thead th{background:#3a3a3a;color:#fff;border:1px solid var(--thin-border);text-align:center;font-weight:600;}
thead th.today{background:var(--today);color:#fff;}
td,th{border:1px solid var(--thin-border);}
td.name,th.name{min-width:140px;max-width:160px;text-align:left;padding-left:10px;font-weight:600;overflow:hidden;text-overflow:ellipsis;background:var(--card);}
td.empty{background:var(--empty);}td.morning{background:var(--morning);}td.evening{background:var(--evening);}td.fullday{background:var(--fullday);}td.training{background:var(--training);}
tbody td{padding:8px;text-align:center;border-radius:6px;word-break:break-word;opacity:0;transform:translateY(10px);transition:all 0.4s ease,background 0.5s ease;position:relative;}
tbody tr.visible td{opacity:1;transform:translateY(0);}
tbody td::after{content:attr(data-tooltip);position:absolute;background:rgba(0,0,0,0.75);color:#fff;padding:2px 6px;font-size:11px;border-radius:4px;white-space:nowrap;top:-28px;left:50%;transform:translateX(-50%);display:none;pointer-events:none;z-index:10;}
tbody td:hover::after{display:block;}
.legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;font-size:13px;}
.legend .card{display:flex;gap:6px;align-items:center;background:#3a3a3a;padding:6px 10px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.4);}
.chip{width:20px;height:14px;border-radius:4px;display:inline-block;border:1px solid #555;}
@media(max-width:760px){td.name,th.name{min-width:120px;max-width:140px;font-size:13px}.controls{gap:8px}thead th,tbody td{font-size:13px;padding:6px}}
</style>
</head>
<body>
<div class="container">
<header>
  <div>
    <h1>–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h1>
    <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É, –º–µ—Å—è—Ü –∏ –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏.</div>
  </div>
  <div class="legend">
    <div class="card"><span class="chip" style="background:var(--morning)">‚òÄÔ∏è</span>–£—Ç—Ä–æ</div>
    <div class="card"><span class="chip" style="background:var(--evening)">üåô</span>–í–µ—á–µ—Ä</div>
    <div class="card"><span class="chip" style="background:var(--fullday)">üïí</span>–í–µ—Å—å –¥–µ–Ω—å</div>
    <div class="card"><span class="chip" style="background:var(--training)">üìö</span>–û–±—É—á–µ–Ω–∏–µ</div>
  </div>
</header>

<div class="controls">
  <label class="control">–¢–æ—á–∫–∞:<select id="branch"><option value="jp">–ñ–∞—Ä-–ü—Ç–∏—Ü–∞</option><option value="czm">–¶–£–ú</option></select></label>
  <label class="control">–ú–µ—Å—è—Ü:<select id="month"></select></label>
  <label class="control">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:<select id="employee"><option value="all">–í—Å–µ</option></select></label>
  <label class="control">–ù–µ–¥–µ–ª—è —Å:<input id="startDate" type="date"/></label>
  <div style="display:flex;align-items:center;gap:8px">
    <button id="showBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
    <button id="refreshBtn" style="background:#3b82f6">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <button id="todayBtn" style="background:#ff9800">–°–µ–≥–æ–¥–Ω—è</button>
  </div>
</div>

<div class="table-wrap">
  <table id="scheduleTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>
</div>

<script>
const tableIDs={jp:"1F_pQYU-Z6DrG7kiIw8EMONKcQ3G2XGO5j41fcisC15U",czm:"1TjZ3EGeviO-23EoYanLv2ZMGLgdg5eozZl59BCgyAao"};
const monthsGIDs={jp:{"–û–∫—Ç—è–±—Ä—å":0,"–ù–æ—è–±—Ä—å":1956542531,"–î–µ–∫–∞–±—Ä—å":987654321},czm:{"–û–∫—Ç—è–±—Ä—å":0,"–ù–æ—è–±—Ä—å":1078468054,"–î–µ–∫–∞–±—Ä—å":987654321}};
let scheduleData=[],csvCache={};

async function loadCSV(branch,month){
  if(csvCache[branch+month])return csvCache[branch+month];
  const gid=monthsGIDs[branch][month];
  const res=await fetch(`https://docs.google.com/spreadsheets/d/${tableIDs[branch]}/export?format=csv&gid=${gid}`);
  const text=await res.text();
  const data=text.split("\n").map(r=>r.split(","));
  csvCache[branch+month]=data;
  return data;
}

function populateMonths(branch){
  const monthSelect=document.getElementById("month");
  monthSelect.innerHTML="";
  Object.keys(monthsGIDs[branch]).forEach(m=>{
    const opt=document.createElement("option"); opt.value=m; opt.textContent=m; monthSelect.appendChild(opt);
  });
}

async function populateEmployees(branch,month){
  scheduleData=await loadCSV(branch,month);
  const employeesSet=new Set();
  for(let i=2;i<scheduleData.length;i++){
    if(scheduleData[i] && scheduleData[i][0]) employeesSet.add(scheduleData[i][0].trim().replace(/^\uFEFF/,""));
  }
  const select=document.getElementById("employee");
  select.innerHTML='<option value="all">–í—Å–µ</option>';
  Array.from(employeesSet).forEach(name=>{
    const opt=document.createElement("option");
    opt.value=name;
    opt.textContent=name;
    select.appendChild(opt);
  });
}

function parseShift(val){
  if(!val) return {type:"empty",label:""};
  const s=String(val).trim().toLowerCase();
  if(s.includes("–≤–¥")) return {type:"fullday",label:"–í–µ—Å—å –¥–µ–Ω—å"};
  if(s.endsWith("—É")) return {type:"morning",label:"–£—Ç—Ä–æ"};
  if(s.endsWith("–≤")) return {type:"evening",label:"–í–µ—á–µ—Ä"};
  if(s.endsWith("–æ")) return {type:"training",label:"–û–±—É—á–µ–Ω–∏–µ"};
  return {type:"empty",label:""};
}

function getWeekDates(start){
  const dates=[];
  for(let i=0;i<7;i++){
    const d=new Date(start);
    d.setDate(d.getDate()+i);
    dates.push(d);
  }
  return dates;
}

function loadSchedule(showToday=false){
  const employee=document.getElementById("employee").value;
  let start=new Date(document.getElementById("startDate").value);
  if(!start.getTime()){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏"); return;}
  const tableHead=document.getElementById("tableHead");
  const tableBody=document.getElementById("tableBody");

  const dateRow=scheduleData[1].slice(2);
  const dateMap=dateRow.map(d=>{
    const parts=d.split('.');
    return new Date(new Date().getFullYear(),parseInt(parts[1],10)-1,parseInt(parts[0],10));
  });

  const weekDates=showToday ? [new Date()] : getWeekDates(start);

  const visibleIndexes=dateMap.map((d,i)=>weekDates.some(wd=>d.toDateString()===wd.toDateString()) ? i+2 : -1).filter(i=>i!==-1);

  const today=new Date();
  const headRow=["–°–æ—Ç—Ä—É–¥–Ω–∏–∫"];
  weekDates.forEach(d=>{
    headRow.push(`${d.getDate().toString().padStart(2,'0')}.${(d.getMonth()+1).toString().padStart(2,'0')}`);
  });

  tableHead.innerHTML="<tr>"+headRow.map((h,i)=>`<th${i===0?' class="name"':''}${(!showToday && today.getDate()===parseInt(h.split('.')[0],10)&&today.getMonth()===parseInt(h.split('.')[1],10)-1)?' class="today"':''}>${h}</th>`).join("")+"</tr>";

  const rows=scheduleData.slice(2,16).filter(r=>r[0] && r[0].trim()!=="");
  tableBody.innerHTML="";
  rows.forEach((r,rowIndex)=>{
    if(employee!=="all" && r[0]!==employee) return;
    let hasShift=false;
    const tr=document.createElement("tr");
    let html=`<td class="name">${r[0]}</td>`;
    visibleIndexes.forEach(col=>{
      const val=r[col] ? r[col].trim() : "";
      const sh=parseShift(val);
      if(sh.type!=="empty") hasShift=true;
      html+=`<td class="${sh.type}" data-tooltip="${val}">${sh.label}</td>`;
    });
    if(showToday && !hasShift) return; // —Å–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç —Å–º–µ–Ω—ã
    tr.innerHTML=html;
    tableBody.appendChild(tr);
    setTimeout(()=>{tr.classList.add("visible");}, rowIndex*80);
  });
}

async function init(){
  const branchSelect=document.getElementById("branch"); 
  populateMonths(branchSelect.value);
  const firstMonth=document.getElementById("month").options[0].value;
  await populateEmployees(branchSelect.value, firstMonth);
  const today=new Date(); const dayOfWeek=today.getDay()||7;
  const firstDay=new Date(today); firstDay.setDate(today.getDate()-dayOfWeek+1);
  document.getElementById("startDate").valueAsDate=firstDay;
}

init();
document.getElementById("branch").addEventListener("change", async e=>{
  const b=e.target.value; populateMonths(b); 
  const firstMonth=document.getElementById("month").options[0].value;
  await populateEmployees(b, firstMonth);
});
document.getElementById("month").addEventListener("change", async e=>{
  await populateEmployees(document.getElementById("branch").value, e.target.value);
});
document.getElementById("showBtn").addEventListener("click", ()=>loadSchedule());
document.getElementById("refreshBtn").addEventListener("click", async ()=>{
  await populateEmployees(document.getElementById("branch").value, document.getElementById("month").value);
  loadSchedule();
});
document.getElementById("todayBtn").addEventListener("click", ()=>loadSchedule(true));
</script>
</body>
</html>
