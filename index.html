<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ì—Ä–∞—Ñ–∏–∫</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-gradient: linear-gradient(135deg,#1e1e1e,#2c2c2c);
  --card:#2a2a2a; --muted:#aaaaaa;
  --accent:#4caf50; --accent-hover:#45a049; --today:#00bcd4;
  --thin-border:#444; --morning:#264f6b; --evening:#665500;
  --fullday:#b3571e; --training:#28a745; --empty:#2a2a2a;
  --font-sans:'Inter', sans-serif; --shadow:0 6px 18px rgba(0,0,0,0.5);
  --text-color:#ffffff;
}
body{margin:0;font-family:var(--font-sans);background:var(--bg-gradient);color:var(--text-color);}
.container{max-width:1100px;margin:28px auto;padding:18px;}
header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
h1{font-size:36px;font-weight:700;color:#fff;background:linear-gradient(135deg,#4caf50,#00bcd4);padding:10px 20px;border-radius:12px;display:inline-block;box-shadow:0 6px 18px rgba(0,0,0,0.5);}
.small{color:var(--muted);}
.controls{display:flex; gap:10px; align-items:end; flex-wrap:wrap; margin-top:12px;}
.control{display:flex;flex-direction:column;font-size:13px;color:var(--text-color);}
select,input[type="date"],button{padding:8px 12px;font-size:14px;border-radius:10px;border:1px solid #555;background:#3a3a3a;color:#fff;transition:all 0.3s;}
select:focus,input[type="date"]:focus{border-color:#3b82f6;outline:none;}
button{background:var(--accent);color:#fff;border:none;cursor:pointer;transition:all 0.3s;}
button:hover{background:var(--accent-hover);}
.table-wrap{margin-top:18px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow);overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:max-content;min-width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed;}
thead th{background:#3a3a3a;color:#fff;border:1px solid var(--thin-border);text-align:center;font-weight:600;}
thead th.today{background:var(--today);color:#fff;}
td,th{border:1px solid var(--thin-border);}
td.name,th.name{min-width:140px;max-width:160px;text-align:left;padding-left:10px;font-weight:600;overflow:hidden;text-overflow:ellipsis;background:var(--card);}
td.empty{background:var(--empty);}td.morning{background:var(--morning);}td.evening{background:var(--evening);}td.fullday{background:var(--fullday);}td.training{background:var(--training);}
tbody td{padding:8px;text-align:center;border-radius:6px;word-break:break-word;opacity:0;transform:translateY(10px);transition:all 0.4s ease,background 0.5s ease;position:relative;}
tbody tr.visible td{opacity:1;transform:translateY(0);}
tbody td::after{content:attr(data-tooltip);position:absolute;background:rgba(0,0,0,0.75);color:#fff;padding:2px 6px;font-size:11px;border-radius:4px;white-space:nowrap;top:-28px;left:50%;transform:translateX(-50%);display:none;pointer-events:none;z-index:10;}
tbody td:hover::after{display:block;}
.legend{display:flex;gap:12px;align-items:center;margin-top:10px;font-size:13px;color:var(--muted);}
.legend .item{display:inline-flex;gap:6px;align-items:center;}
.chip{width:20px;height:14px;border-radius:4px;display:inline-block;border:1px solid #555;}
@media (max-width:760px){td.name,th.name{min-width:120px;max-width:140px;font-size:13px}.controls{gap:8px}thead th,tbody td{font-size:13px;padding:6px}}
</style>
</head>
<body>
<div class="container">
<header>
  <div>
    <h1>–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h1>
    <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É, –º–µ—Å—è—Ü –∏ –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏.</div>
  </div>
  <div class="legend">
    <div class="item"><span class="chip" style="background:var(--morning)">‚òÄÔ∏è</span>–£—Ç—Ä–æ</div>
    <div class="item"><span class="chip" style="background:var(--evening)">üåô</span>–í–µ—á–µ—Ä</div>
    <div class="item"><span class="chip" style="background:var(--fullday)">üïí</span>–í–µ—Å—å –¥–µ–Ω—å</div>
    <div class="item"><span class="chip" style="background:var(--training)">üìö</span>–û–±—É—á–µ–Ω–∏–µ</div>
  </div>
</header>

<div class="controls">
  <label class="control">–¢–æ—á–∫–∞:
    <select id="branch">
      <option value="jp">–ñ–∞—Ä-–ü—Ç–∏—Ü–∞</option>
      <option value="czm">–¶–£–ú</option>
    </select>
  </label>
  <label class="control">–ú–µ—Å—è—Ü:
    <select id="month"></select>
  </label>
  <label class="control">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:
    <select id="employee"><option value="all">–í—Å–µ</option></select>
  </label>
  <label class="control">–ù–µ–¥–µ–ª—è —Å:
    <input id="startDate" type="date"/>
  </label>
  <div style="display:flex;align-items:center;gap:8px">
    <button id="showBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
    <button id="refreshBtn" style="background:#3b82f6">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <button id="todayBtn" style="background:var(--today)">–°–µ–≥–æ–¥–Ω—è</button>
  </div>
</div>

<div class="table-wrap">
  <table id="scheduleTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>
</div>
<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü
const tableIDs = { 
  jp: "1F_pQYU-Z6DrG7kiIw8EMONKcQ3G2XGO5j41fcisC15U", 
  czm: "1TjZ3EGeviO-23EoYanLv2ZMGLgdg5eozZl59BCgyAao" 
};

const monthsGIDs = { 
  jp: {"–û–∫—Ç—è–±—Ä—å": 0, "–ù–æ—è–±—Ä—å": 1956542531, "–î–µ–∫–∞–±—Ä—å": 987654321}, 
  czm: {"–û–∫—Ç—è–±—Ä—å": 0, "–ù–æ—è–±—Ä—å": 1078468054, "–î–µ–∫–∞–±—Ä—å": 987654321} 
};

// –ö—ç—à –¥–∞–Ω–Ω—ã—Ö
const cachedCSVs = {};

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
let currentBranch = null;
let currentMonth = null;
let scheduleData = [];

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ CSV
async function loadCSV(branch, month) {
  const cacheKey = `${branch}_${month}`;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
  if (cachedCSVs[cacheKey]) {
    return cachedCSVs[cacheKey];
  }
  
  const gid = monthsGIDs[branch][month];
  const url = `https://docs.google.com/spreadsheets/d/${tableIDs[branch]}/export?format=csv&gid=${gid}`;
  
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${res.status}`);
    
    const text = await res.text();
    const parsed = text.split("\n").map(r => r.split(","));
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    cachedCSVs[cacheKey] = parsed;
    return parsed;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    return [];
  }
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏
function populateMonths(branch) {
  const monthSelect = document.getElementById("month");
  monthSelect.innerHTML = "";
  
  Object.keys(monthsGIDs[branch]).forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    monthSelect.appendChild(opt);
  });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
async function populateEmployees(branch, month) {
  try {
    scheduleData = await loadCSV(branch, month);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    currentBranch = branch;
    currentMonth = month;
    
    const employeesSet = new Set();
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º–µ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
    for (let i = 2; i <= 15; i++) {
      if (scheduleData[i] && scheduleData[i][0] && scheduleData[i][0].trim() !== "") {
        employeesSet.add(scheduleData[i][0].trim().replace(/^\uFEFF/, ""));
      }
    }
    
    const select = document.getElementById("employee");
    select.innerHTML = '<option value="all">–í—Å–µ</option>';
    
    Array.from(employeesSet).forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    loadSchedule();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
  }
}

// –ü–∞—Ä—Å–∏–Ω–≥ —Å–º–µ–Ω—ã
function parseShift(val) {
  if (!val) return { type: "empty", label: "" };
  
  const s = String(val).trim().toLowerCase();
  if (s.includes("–≤–¥")) return { type: "fullday", label: "–í–µ—Å—å –¥–µ–Ω—å" };
  if (s.endsWith("—É")) return { type: "morning", label: "–£—Ç—Ä–æ" };
  if (s.endsWith("–≤")) return { type: "evening", label: "–í–µ—á–µ—Ä" };
  if (s.endsWith("–æ")) return { type: "training", label: "–û–±—É—á–µ–Ω–∏–µ" };
  
  return { type: "empty", label: "" };
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay() || 7;
  d.setDate(d.getDate() - day + 1);
  return d;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
function formatDate(d) {
  return `${d.getDate().toString().padStart(2, '0')}.${(d.getMonth() + 1).toString().padStart(2, '0')}`;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function loadSchedule() {
  const employee = document.getElementById("employee").value;
  const selectedDate = new Date(document.getElementById("startDate").value);
  
  if (!selectedDate.getTime()) {
    alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏");
    return;
  }
  
  const tableHead = document.getElementById("tableHead");
  const tableBody = document.getElementById("tableBody");
  
  // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
  tableHead.innerHTML = "";
  tableBody.innerHTML = "";
  
  // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –≤—ã—Ö–æ–¥–∏–º
  if (!scheduleData.length) {
    return;
  }
  
  const weekStart = getWeekStart(selectedDate);
  const weekDates = [];
  
  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    weekDates.push(d);
  }
  
  const dateRow = (scheduleData[1] || []).slice(2);
  const dateIndexMap = weekDates.map(d => {
    for (let i = 0; i < dateRow.length; i++) {
      const parts = dateRow[i].split('.');
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      
      if (day === d.getDate() && month === d.getMonth() + 1) {
        return i + 2;
      }
    }
    return null;
  });
  
  const today = new Date();
  
  // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
  tableHead.innerHTML = "<tr><th class='name'>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>" +
    weekDates.map(d => `<th${d.toDateString() === today.toDateString() ? ' class="today"' : ''}>${formatDate(d)}</th>`).join("") + "</tr>";
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
  const rows = (scheduleData.slice(2, 16) || []).filter(r => r[0] && r[0].trim() !== "");
  
  // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
  rows.forEach((r, rowIndex) => {
    if (employee !== "all" && r[0] !== employee) return;
    
    const tr = document.createElement("tr");
    let html = `<td class="name">${r[0]}</td>`;
    
    dateIndexMap.forEach(idx => {
      let val = "";
      if (idx !== null && r[idx]) val = r[idx].trim();
      
      const sh = parseShift(val);
      html += `<td class="${sh.type}" data-tooltip="${val}">${sh.label}</td>`;
    });
    
    tr.innerHTML = html;
    tableBody.appendChild(tr);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
    setTimeout(() => {
      tr.classList.add("visible");
    }, rowIndex * 80);
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async function init() {
  const branchSelect = document.getElementById("branch");
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ—Å—è—Ü—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ç–æ—á–∫–∏
  populateMonths(branchSelect.value);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –º–µ—Å—è—Ü–∞
  const firstMonth = document.getElementById("month").options[0] ? document.getElementById("month").options[0].value : null;
  if (firstMonth) {
    await populateEmployees(branchSelect.value, firstMonth);
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
  const today = new Date();
  const firstDay = getWeekStart(today);
  document.getElementById("startDate").valueAsDate = firstDay;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
init();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.getElementById("todayBtn").addEventListener("click", () => {
  const today = new Date();
  const day = today.getDate();
  const month = today.getMonth() + 1;

  const tableHead = document.getElementById("tableHead");
  const tableBody = document.getElementById("tableBody");

  // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
  tableHead.innerHTML = "";
  tableBody.innerHTML = "";

  // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –≤—ã—Ö–æ–¥–∏–º
  if (!scheduleData.length) {
    return;
  }

  const dateRow = (scheduleData[1] || []).slice(2);
  let targetIndex = null;

  for (let i = 0; i < dateRow.length; i++) {
    const parts = dateRow[i].split('.');
    const d = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    
    if (d === day && m === month) {
      targetIndex = i + 2;
      break;
    }
  }

  if (targetIndex === null) {
    alert("–¢–µ–∫—É—â–µ–π –¥–∞—Ç—ã –Ω–µ—Ç –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ");
    return;
  }

  tableHead.innerHTML = `
    <tr>
      <th class="name">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
      <th class="today">${String(day).padStart(2, '0')}.${String(month).padStart(2, '0')}</th>
    </tr>
  `;

  const rows = (scheduleData.slice(2, 16) || []).filter(r => r[0] && r[0].trim() !== "");
  let visibleIndex = 0;
  
  rows.forEach((r) => {
    const val = r[targetIndex] ? r[targetIndex].trim() : "";
    if (!val) return;
    
    const sh = parseShift(val);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name">${r[0]}</td>
      <td class="${sh.type}" data-tooltip="${val}">${sh.label}</td>
    `;
    tableBody.appendChild(tr);
    
    setTimeout(() => {
      tr.classList.add("visible");
    }, visibleIndex * 80);
    
    visibleIndex++;
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ—á–∫–∏
document.getElementById("branch").addEventListener("change", async e => {
  const b = e.target.value;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤
  populateMonths(b);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –º–µ—Å—è—Ü–∞
  const firstMonth = document.getElementById("month").options[0] ? document.getElementById("month").options[0].value : null;
  if (firstMonth) {
    await populateEmployees(b, firstMonth);
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ—Å—è—Ü–∞
document.getElementById("month").addEventListener("change", async e => {
  const branch = document.getElementById("branch").value;
  await populateEmployees(branch, e.target.value);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
document.getElementById("showBtn").addEventListener("click", loadSchedule);

document.getElementById("refreshBtn").addEventListener("click", async () => {
  const branch = document.getElementById("branch").value;
  const month = document.getElementById("month").value;
  
  // –û—á–∏—â–∞–µ–º –∫—ç—à –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ç–æ—á–∫–∏ –∏ –º–µ—Å—è—Ü–∞
  const cacheKey = `${branch}_${month}`;
  delete cachedCSVs[cacheKey];
  
  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  await populateEmployees(branch, month);
});
</script>
</body>
</html>
