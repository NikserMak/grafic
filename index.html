<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>График сотрудников</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-gradient: linear-gradient(135deg,#1e1e1e,#2c2c2c);
  --card:#2a2a2a; --muted:#aaaaaa;
  --accent:#4caf50; --accent-hover:#45a049; --today:#00bcd4;
  --thin-border:#444; --morning:#1e4a63; --evening:#7a5c00;
  --fullday:#a34e1a; --training:#21963a; --empty:#2a2a2a;
  --font-sans:'Inter', sans-serif; --shadow:0 6px 18px rgba(0,0,0,0.5);
  --text-color:#ffffff;
  --error:#f44336; --warning:#ff9800; --success:#4caf50;
}
body{
  margin:0;
  font-family:var(--font-sans);
  background:var(--bg-gradient);
  color:var(--text-color);
  min-height:100vh;
}
.container{
  max-width:1100px;
  margin:28px auto;
  padding:18px;
}
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  flex-wrap:wrap;
}
h1{
  font-size:36px;
  font-weight:700;
  color:#fff;
  background:linear-gradient(135deg,#4caf50,#00bcd4);
  padding:10px 20px;
  border-radius:12px;
  display:inline-block;
  box-shadow:var(--shadow);
}
.small{
  color:var(--muted);
  margin-top:8px;
}
.controls{
  display:flex; 
  gap:12px; 
  align-items:end; 
  flex-wrap:wrap; 
  margin-top:20px;
}
.control{
  display:flex;
  flex-direction:column;
  font-size:13px;
  color:var(--text-color);
  min-width:120px;
}
select, input[type="date"], button{
  padding:10px 12px;
  font-size:14px;
  border-radius:10px;
  border:1px solid #555;
  background:#3a3a3a;
  color:#fff;
  transition:all 0.3s;
  margin-top:4px;
}
select:focus, input[type="date"]:focus{
  border-color:#3b82f6;
  outline:none;
  box-shadow:0 0 0 2px rgba(59, 130, 246, 0.2);
}
button{
  background:var(--accent);
  color:#fff;
  border:none;
  cursor:pointer;
  transition:all 0.3s;
  font-weight:500;
  min-width:100px;
}
button:hover{
  background:var(--accent-hover);
  transform:translateY(-1px);
}
button:active{
  transform:translateY(0);
}
button:disabled{
  opacity:0.6;
  cursor:not-allowed;
  transform:none;
}
.table-wrap{
  margin-top:24px;
  background:var(--card);
  border-radius:14px;
  padding:16px;
  box-shadow:var(--shadow);
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  position:relative;
  min-height:200px;
}
table{
  width:max-content;
  min-width:100%;
  border-collapse:collapse;
  font-size:14px;
  table-layout:fixed;
}
thead th{
  background:#3a3a3a;
  color:#fff;
  border:1px solid var(--thin-border);
  text-align:center;
  font-weight:600;
  padding:12px 8px;
  position:sticky;
  top:0;
  z-index:10;
}
thead th.today{
  background:var(--today);
  color:#fff;
}
td, th{
  border:1px solid var(--thin-border);
  padding:10px 8px;
}
td.name, th.name{
  min-width:140px;
  max-width:160px;
  text-align:left;
  padding-left:12px;
  font-weight:600;
  overflow:hidden;
  text-overflow:ellipsis;
  background:var(--card);
  position:sticky;
  left:0;
  z-index:5;
}
td.empty{background:var(--empty);}
td.morning{background:var(--morning);}
td.evening{background:var(--evening);}
td.fullday{background:var(--fullday);}
td.training{background:var(--training);}
tbody td{
  text-align:center;
  border-radius:6px;
  word-break:break-word;
  opacity:0;
  transform:translateY(10px);
  transition:all 0.4s ease,background 0.5s ease;
  position:relative;
}
tbody tr.visible td{
  opacity:1;
  transform:translateY(0);
}
tbody td::after{
  content:attr(data-tooltip);
  position:absolute;
  background:rgba(0,0,0,0.9);
  color:#fff;
  padding:6px 10px;
  font-size:12px;
  border-radius:6px;
  white-space:nowrap;
  top:-40px;
  left:50%;
  transform:translateX(-50%);
  display:none;
  pointer-events:none;
  z-index:20;
  box-shadow:0 4px 8px rgba(0,0,0,0.3);
}
tbody td:hover::after{
  display:block;
}
.legend{
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:10px;
  font-size:13px;
  color:var(--muted);
  flex-wrap:wrap;
}
.legend .item{
  display:inline-flex;
  gap:6px;
  align-items:center;
}
.chip{
  width:20px;
  height:14px;
  border-radius:4px;
  display:inline-block;
  border:1px solid #555;
}

/* Индикатор загрузки */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin-right: 8px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Уведомления */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 8px;
  color: white;
  font-weight: 500;
  z-index: 1000;
  transform: translateX(400px);
  transition: transform 0.3s ease;
  max-width: 400px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.notification.show {
  transform: translateX(0);
}
.notification.success {
  background: var(--success);
}
.notification.error {
  background: var(--error);
}
.notification.warning {
  background: var(--warning);
}

/* Мобильная оптимизация */
@media (max-width: 768px) {
  .container {
    padding: 12px;
    margin: 10px auto;
  }
  
  h1 {
    font-size: 24px;
    padding: 8px 16px;
    text-align: center;
    width: 100%;
  }
  
  header {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  .controls {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  
  .control {
    min-width: auto;
    width: 100%;
  }
  
  .buttons-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    width: 100%;
  }
  
  .buttons-container button {
    min-width: auto;
    width: 100%;
  }
  
  .table-wrap {
    margin-top: 16px;
    padding: 10px;
    border-radius: 10px;
  }
  
  td.name, th.name {
    min-width: 100px;
    max-width: 120px;
    font-size: 12px;
    padding: 6px 8px;
  }
  
  thead th, tbody td {
    font-size: 12px;
    padding: 6px 4px;
  }
  
  .legend {
    justify-content: center;
    gap: 8px;
  }
  
  .notification {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
  }
}

@media (max-width: 480px) {
  h1 {
    font-size: 20px;
  }
  
  .buttons-container {
    grid-template-columns: 1fr;
  }
  
  td.name, th.name {
    min-width: 80px;
    max-width: 100px;
    font-size: 11px;
  }
}
</style>
</head>
<body>
<!-- Уведомления -->
<div id="notificationsContainer"></div>

<div class="container">
<header>
  <div>
    <h1>График сотрудников</h1>
    <div class="small">Выберите точку, месяц и начало недели. Данные обновляются автоматически.</div>
  </div>
  <div class="legend">
    <div class="item"><span class="chip" style="background:var(--morning)"></span>Утро</div>
    <div class="item"><span class="chip" style="background:var(--evening)"></span>Вечер</div>
    <div class="item"><span class="chip" style="background:var(--fullday)"></span>Весь день</div>
    <div class="item"><span class="chip" style="background:var(--training)"></span>Обучение</div>
  </div>
</header>

<div class="controls">
  <label class="control">Точка:
    <select id="branch">
      <option value="jp">Жар-Птица</option>
      <option value="czm">ЦУМ</option>
    </select>
  </label>
  
  <label class="control">Месяц:
    <select id="month"></select>
  </label>
  
  <label class="control">Сотрудник:
    <select id="employee"><option value="all">Все сотрудники</option></select>
  </label>
  
  <label class="control">Неделя с:
    <input id="startDate" type="date"/>
  </label>
  
  <div class="buttons-container">
    <button id="showBtn">
      <span class="loading" id="loadingIndicator" style="display:none;"></span>
      Показать график
    </button>
    <button id="refreshBtn" style="background:#3b82f6">Обновить</button>
    <button id="todayBtn" style="background:var(--today)">Сегодня</button>
  </div>
</div>

<div class="table-wrap">
  <div id="tableLoading" style="display:none; text-align:center; padding:40px;">
    <div class="loading" style="margin:0 auto;"></div>
    <div style="margin-top:10px;">Загрузка данных...</div>
  </div>
  <table id="scheduleTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>
</div>

<script>
// Конфигурация таблиц
const tableIDs = { 
  jp: "1F_pQYU-Z6DrG7kiIw8EMONKcQ3G2XGO5j41fcisC15U", 
  czm: "1TjZ3EGeviO-23EoYanLv2ZMGLgdg5eozZl59BCgyAao" 
};

const monthsGIDs = { 
  jp: {"Октябрь": 0, "Ноябрь": 1956542531, "Декабрь": 987654321}, 
  czm: {"Октябрь": 0, "Ноябрь": 1078468054, "Декабрь": 987654321} 
};

// Кэш данных
const cachedCSVs = {};

// Переменные состояния
let currentBranch = null;
let currentMonth = null;
let scheduleData = [];
let allEmployees = [];

// ========== УВЕДОМЛЕНИЯ ==========
function showNotification(message, type = 'success', duration = 4000) {
  const container = document.getElementById('notificationsContainer');
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  
  container.appendChild(notification);
  
  // Анимация появления
  setTimeout(() => notification.classList.add('show'), 100);
  
  // Автоматическое скрытие
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// ========== ИНДИКАТОР ЗАГРУЗКИ ==========
function setLoading(isLoading, element = 'table') {
  if (element === 'table') {
    const loadingEl = document.getElementById('tableLoading');
    const tableEl = document.getElementById('scheduleTable');
    if (isLoading) {
      loadingEl.style.display = 'block';
      tableEl.style.display = 'none';
    } else {
      loadingEl.style.display = 'none';
      tableEl.style.display = 'table';
    }
  } else if (element === 'button') {
    const indicator = document.getElementById('loadingIndicator');
    const showBtn = document.getElementById('showBtn');
    if (isLoading) {
      indicator.style.display = 'inline-block';
      showBtn.disabled = true;
    } else {
      indicator.style.display = 'none';
      showBtn.disabled = false;
    }
  }
}

// ========== LOCALSTORAGE ==========
function saveState() {
  const state = {
    branch: document.getElementById('branch').value,
    month: document.getElementById('month').value,
    employee: document.getElementById('employee').value,
    startDate: document.getElementById('startDate').value
  };
  try {
    localStorage.setItem('scheduleState', JSON.stringify(state));
  } catch (e) {
    console.warn('Не удалось сохранить состояние:', e);
  }
}

function loadState() {
  try {
    const saved = localStorage.getItem('scheduleState');
    if (saved) {
      const state = JSON.parse(saved);
      if (state.branch) document.getElementById('branch').value = state.branch;
      if (state.month) document.getElementById('month').value = state.month;
      if (state.employee) document.getElementById('employee').value = state.employee;
      if (state.startDate) document.getElementById('startDate').value = state.startDate;
      return true;
    }
  } catch (e) {
    console.warn('Не удалось загрузить состояние:', e);
  }
  return false;
}

// ========== ОСНОВНЫЕ ФУНКЦИИ ==========
async function loadCSV(branch, month, retryCount = 3) {
  const cacheKey = `${branch}_${month}`;
  
  // Проверяем кэш
  if (cachedCSVs[cacheKey]) {
    return cachedCSVs[cacheKey];
  }
  
  const gid = monthsGIDs[branch][month];
  const url = `https://docs.google.com/spreadsheets/d/${tableIDs[branch]}/export?format=csv&gid=${gid}`;
  
  for (let attempt = 1; attempt <= retryCount; attempt++) {
    try {
      setLoading(true, 'button');
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Ошибка загрузки: ${res.status}`);
      
      const text = await res.text();
      const parsed = text.split("\n").map(r => r.split(","));
      
      // Сохраняем в кэш
      cachedCSVs[cacheKey] = parsed;
      showNotification(`Данные для ${month} загружены`, 'success');
      return parsed;
    } catch (error) {
      console.error(`Попытка ${attempt} не удалась:`, error);
      if (attempt === retryCount) {
        showNotification('Не удалось загрузить данные. Проверьте подключение к интернету.', 'error', 6000);
        throw error;
      }
      // Ждем перед повторной попыткой
      await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
    } finally {
      setLoading(false, 'button');
    }
  }
}

function populateMonths(branch) {
  const monthSelect = document.getElementById("month");
  const currentValue = monthSelect.value;
  monthSelect.innerHTML = "";
  
  Object.keys(monthsGIDs[branch]).forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    monthSelect.appendChild(opt);
  });
  
  // Восстанавливаем значение если возможно
  if (currentValue && [...monthSelect.options].some(opt => opt.value === currentValue)) {
    monthSelect.value = currentValue;
  }
}

async function populateEmployees(branch, month) {
  try {
    setLoading(true, 'table');
    scheduleData = await loadCSV(branch, month);
    
    // Обновляем состояние
    currentBranch = branch;
    currentMonth = month;
    
    const employeesSet = new Set();
    
    // Извлекаем имена сотрудников из данных
    for (let i = 2; i <= 15; i++) {
      if (scheduleData[i] && scheduleData[i][0] && scheduleData[i][0].trim() !== "") {
        employeesSet.add(scheduleData[i][0].trim().replace(/^\uFEFF/, ""));
      }
    }
    
    allEmployees = Array.from(employeesSet);
    const select = document.getElementById("employee");
    const currentValue = select.value;
    
    select.innerHTML = '<option value="all">Все сотрудники</option>';
    
    allEmployees.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
    
    // Восстанавливаем предыдущее значение
    if (currentValue && (currentValue === 'all' || allEmployees.includes(currentValue))) {
      select.value = currentValue;
    }
    
  } catch (error) {
    console.error('Ошибка загрузки сотрудников:', error);
    scheduleData = [];
  } finally {
    setLoading(false, 'table');
  }
}

// Парсинг смены - ИСПРАВЛЕННАЯ ВЕРСИЯ
function parseShift(val) {
  if (!val) return { type: "empty", label: "" };
  
  const s = String(val).trim().toLowerCase();
  
  // Обработка дробных чисел (3,5у, 2.5в и т.д.) - показываем как "Утро"/"Вечер"
  const hourMatch = s.match(/^(\d+[,.]\d+)([ув])$/);
  if (hourMatch) {
    const shiftType = hourMatch[2];
    const type = shiftType === 'у' ? 'morning' : 'evening';
    const label = shiftType === 'у' ? 'Утро' : 'Вечер';
    return { type: type, label: label };
  }
  
  // Обработка целых чисел с часами (3у, 2в и т.д.) - показываем как "Утро"/"Вечер"
  const intHourMatch = s.match(/^(\d+)([ув])$/);
  if (intHourMatch) {
    const shiftType = intHourMatch[2];
    const type = shiftType === 'у' ? 'morning' : 'evening';
    const label = shiftType === 'у' ? 'Утро' : 'Вечер';
    return { type: type, label: label };
  }
  
  // Стандартные проверки
  if (s.includes("вд")) return { type: "fullday", label: "Весь день" };
  if (s.endsWith("у")) return { type: "morning", label: "Утро" };
  if (s.endsWith("в")) return { type: "evening", label: "Вечер" };
  if (s.endsWith("о")) return { type: "training", label: "Обучение" };
  
  return { type: "empty", label: "" };
}

function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay() || 7;
  d.setDate(d.getDate() - day + 1);
  return d;
}

function formatDate(d) {
  return `${d.getDate().toString().padStart(2, '0')}.${(d.getMonth() + 1).toString().padStart(2, '0')}`;
}

function loadSchedule() {
  const employee = document.getElementById("employee").value;
  const selectedDate = new Date(document.getElementById("startDate").value);
  
  if (!selectedDate.getTime()) {
    showNotification("Выберите дату начала недели", "error");
    return;
  }
  
  const tableHead = document.getElementById("tableHead");
  const tableBody = document.getElementById("tableBody");
  
  // Очищаем таблицу
  tableHead.innerHTML = "";
  tableBody.innerHTML = "";
  
  // Если нет данных, выходим
  if (!scheduleData.length) {
    showNotification("Нет данных для отображения", "warning");
    return;
  }
  
  const weekStart = getWeekStart(selectedDate);
  const weekDates = [];
  
  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    weekDates.push(d);
  }
  
  const dateRow = (scheduleData[1] || []).slice(2);
  const dateIndexMap = weekDates.map(d => {
    for (let i = 0; i < dateRow.length; i++) {
      const parts = dateRow[i].split('.');
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      
      if (day === d.getDate() && month === d.getMonth() + 1) {
        return i + 2;
      }
    }
    return null;
  });
  
  const today = new Date();
  
  // Создаем заголовок таблицы
  tableHead.innerHTML = "<tr><th class='name'>Сотрудник</th>" +
    weekDates.map(d => `<th${d.toDateString() === today.toDateString() ? ' class="today"' : ''}>${formatDate(d)}</th>`).join("") + "</tr>";
  
  // Фильтруем строки с данными сотрудников
  const rows = (scheduleData.slice(2, 16) || []).filter(r => r[0] && r[0].trim() !== "");
  
  let visibleRows = 0;
  
  // Создаем строки таблицы
  rows.forEach((r, rowIndex) => {
    if (employee !== "all" && r[0] !== employee) return;
    
    const tr = document.createElement("tr");
    let html = `<td class="name">${r[0]}</td>`;
    
    dateIndexMap.forEach(idx => {
      let val = "";
      if (idx !== null && r[idx]) val = r[idx].trim();
      
      const sh = parseShift(val);
      html += `<td class="${sh.type}" data-tooltip="${val}">${sh.label}</td>`;
    });
    
    tr.innerHTML = html;
    tableBody.appendChild(tr);
    
    // Анимация появления строки
    setTimeout(() => {
      tr.classList.add("visible");
    }, rowIndex * 80);
    
    visibleRows++;
  });
  
  if (visibleRows === 0) {
    showNotification("Нет данных для выбранного сотрудника", "warning");
  } else {
    showNotification(`Показано: ${employee === "all" ? "все сотрудники" : employee}`, "success", 2000);
  }
  
  saveState();
}

// ========== ИНИЦИАЛИЗАЦИЯ ==========
async function init() {
  // Загружаем сохраненное состояние
  loadState();
  
  const branchSelect = document.getElementById("branch");
  
  // Заполняем месяцы для текущей точки
  populateMonths(branchSelect.value);
  
  // Загружаем сотрудников для текущего месяца
  const currentMonth = document.getElementById("month").value;
  if (currentMonth) {
    await populateEmployees(branchSelect.value, currentMonth);
  }
  
  // Устанавливаем дату начала текущей недели если не установлена
  if (!document.getElementById("startDate").value) {
    const today = new Date();
    const firstDay = getWeekStart(today);
    document.getElementById("startDate").valueAsDate = firstDay;
  }
  
  // Загружаем график
  loadSchedule();
}

// ========== ОБРАБОТЧИКИ СОБЫТИЙ ==========
document.getElementById("todayBtn").addEventListener("click", () => {
  const today = new Date();
  const firstDay = getWeekStart(today);
  document.getElementById("startDate").valueAsDate = firstDay;
  loadSchedule();
});

document.getElementById("branch").addEventListener("change", async e => {
  const b = e.target.value;
  populateMonths(b);
  saveState();
  
  const firstMonth = document.getElementById("month").value;
  if (firstMonth) {
    await populateEmployees(b, firstMonth);
  }
});

document.getElementById("month").addEventListener("change", async e => {
  const branch = document.getElementById("branch").value;
  await populateEmployees(branch, e.target.value);
  saveState();
});

document.getElementById("employee").addEventListener("change", () => {
  loadSchedule();
  saveState();
});

document.getElementById("startDate").addEventListener("change", () => {
  loadSchedule();
  saveState();
});

document.getElementById("showBtn").addEventListener("click", loadSchedule);

document.getElementById("refreshBtn").addEventListener("click", async () => {
  const branch = document.getElementById("branch").value;
  const month = document.getElementById("month").value;
  
  // Очищаем кэш для текущей точки и месяца
  const cacheKey = `${branch}_${month}`;
  delete cachedCSVs[cacheKey];
  
  showNotification("Обновление данных...", "warning", 2000);
  
  // Перезагружаем данные
  await populateEmployees(branch, month);
});

// Автоматическое обновление данных каждые 10 минут
setInterval(async () => {
  const branch = document.getElementById("branch").value;
  const month = document.getElementById("month").value;
  
  if (branch && month) {
    const cacheKey = `${branch}_${month}`;
    delete cachedCSVs[cacheKey];
    await populateEmployees(branch, month);
    showNotification('Данные автоматически обновлены', 'success', 3000);
  }
}, 10 * 60 * 1000);

// Инициализация при загрузке страницы
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
