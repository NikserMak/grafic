<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>График сотрудников — ЖП / ЦУМ</title>
<style>
body{
  font-family: "Helvetica Neue", Arial, sans-serif;
  margin:0;
  background:#1e1e1e;
  color:#fff;
}
.container{
  max-width:1100px;
  margin:28px auto;
  padding:18px;
}
header h1{margin:0;font-size:26px;}
.controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
.control{display:flex;flex-direction:column;font-size:13px;}
select,input[type="date"],button{
  padding:8px 12px;
  font-size:14px;
  border-radius:10px;
  border:1px solid #555;
  background:#3a3a3a;
  color:#fff;
}
button{background:#4caf50; cursor:pointer; border:none;}
button:hover{background:#45a049;}
.table-wrap{
  margin-top:18px;
  background:#2a2a2a;
  border-radius:10px;
  padding:12px;
  overflow-x:auto;
}
table{
  width:max-content;
  min-width:100%;
  border-collapse: collapse;
  font-size:14px;
}
th, td{
  border:1px solid #444;
  padding:8px;
  text-align:center;
}
thead th{background:#3a3a3a; color:#fff; font-weight:600;}
td.morning{background:#264f6b;}
td.evening{background:#665500;}
td.fullday{background:#b3571e;}
td.empty{background:#2a2a2a;}
</style>
</head>
<body>
<div class="container">
<header>
  <h1>График сотрудников — Жар-Птица / ЦУМ</h1>
</header>

<div class="controls">
  <label class="control">Точка:
    <select id="branch">
      <option value="jp">Жар-Птица</option>
      <option value="czm">ЦУМ</option>
    </select>
  </label>
  <label class="control">Месяц:
    <select id="month"></select>
  </label>
  <label class="control">Сотрудник:
    <select id="employee"><option value="all">Все</option></select>
  </label>
  <label class="control">Неделя с:
    <input id="startDate" type="date"/>
  </label>
  <button id="showBtn">Показать график</button>
</div>

<div class="table-wrap">
  <table id="scheduleTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>
</div>

<script>
// Настройки таблиц
const tableIDs = { jp:"1F_pQYU-Z6DrG7kiIw8EMONKcQ3G2XGO5j41fcisC15U", czm:"1TjZ3EGeviO-23EoYanLv2ZMGLgdg5eozZl59BCgyAao" };
const monthsGIDs = { jp:{"Октябрь":0,"Ноябрь":1956542531,"Декабрь":987654321}, czm:{"Октябрь":0,"Ноябрь":1078468054,"Декабрь":987654321} };
let scheduleData = [];

async function loadCSV(branch, month){
  const gid = monthsGIDs[branch][month];
  const url = `https://docs.google.com/spreadsheets/d/${tableIDs[branch]}/export?format=csv&gid=${gid}`;
  const res = await fetch(url);
  const text = await res.text();
  return text.split("\n").map(r=>r.split(","));
}

function populateMonths(branch){
  const monthSelect = document.getElementById("month"); monthSelect.innerHTML="";
  Object.keys(monthsGIDs[branch]).forEach(m=>{
    const opt=document.createElement("option"); opt.value=m; opt.textContent=m; monthSelect.appendChild(opt);
  });
}

async function populateEmployees(branch, month){
  scheduleData = await loadCSV(branch, month);
  const employeesSet = new Set();
  for(let i=2;i<=15;i++){ if(scheduleData[i] && scheduleData[i][0]) employeesSet.add(scheduleData[i][0].trim().replace(/^\uFEFF/,"")); }
  const select = document.getElementById("employee");
  select.innerHTML='<option value="all">Все</option>';
  Array.from(employeesSet).forEach(name=>{ const opt=document.createElement("option"); opt.value=name; opt.textContent=name; select.appendChild(opt); });
}

function parseShift(val){
  if(!val) return {type:"empty",label:""}; const s=String(val).trim().toLowerCase();
  if(s.includes("вд")) return {type:"fullday",label:"Весь день"};
  if(s.endsWith("у")) return {type:"morning",label:"Утро"};
  if(s.endsWith("в")) return {type:"evening",label:"Вечер"};
  return {type:"empty",label:""};
}

function loadSchedule(){
  const employee=document.getElementById("employee").value;
  const startDate=new Date(document.getElementById("startDate").value);
  if(!startDate.getTime()){ alert("Выберите дату начала недели"); return;}
  const tableHead=document.getElementById("tableHead");
  const tableBody=document.getElementById("tableBody");

  // Заголовок
  const headRow=["Сотрудник"];
  for(let i=0;i<7;i++){
    const d=new Date(startDate); d.setDate(d.getDate()+i);
    headRow.push(d.toLocaleDateString());
  }
  tableHead.innerHTML="<tr>"+headRow.map(h=>`<th>${h}</th>`).join("")+"</tr>";

  // Фильтруем строки с именем сотрудника
  const rows = scheduleData.slice(2,16).filter(r=>r[0] && r[0].trim()!=="");
  tableBody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    let html=`<td>${r[0]}</td>`;
    for(let i=1;i<=7;i++){
      const val=r[i] ? r[i].trim() : "";
      let type="empty",label="";
      if(val.toLowerCase().includes("вд")){type="fullday";label="Весь день";}
      else if(val.endsWith("у")){type="morning";label="Утро";}
      else if(val.endsWith("в")){type="evening";label="Вечер";}
      html+=`<td class="${type}">${label}</td>`;
    }
    tr.innerHTML=html;
    tableBody.appendChild(tr);
  });
}

async function init(){
  const branchSelect=document.getElementById("branch"); populateMonths(branchSelect.value);
  const firstMonth=document.getElementById("month").options[0].value;
  await populateEmployees(branchSelect.value, firstMonth);
  const today=new Date(); const dayOfWeek=today.getDay()===0?7:today.getDay();
  const firstDay=new Date(today); firstDay.setDate(today.getDate()-dayOfWeek+1); document.getElementById("startDate").valueAsDate=firstDay;
}

init();
document.getElementById("branch").addEventListener("change", async e=>{ const b=e.target.value; populateMonths(b); const firstMonth=document.getElementById("month").options[0].value; await populateEmployees(b, firstMonth); });
document.getElementById("month").addEventListener("change", async e=>{ await populateEmployees(document.getElementById("branch").value, e.target.value); });
document.getElementById("showBtn").addEventListener("click", loadSchedule);
</script>
</body>
</html>
